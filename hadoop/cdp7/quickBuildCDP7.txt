###Setup Isilon and client for CDP7



###On Isilon
###Setup smartconnect for isilon  --- standard isilon SC setup and network setup
-isilon.demo.local
test ssip & sc, forward and reverse DNS on smartconnect
###1a.setup SmartConnect on Isilon
isi network subnets modify groupnet0.subnet0 --sc-service-addr=192.168.1.100 --sc-service-name=ssip-isilon.demo.local
isi network pools create --id=groupnet0:subnet0:pool1 --ranges=192.168.1.60-192.168.1.990  --access-zone=System  --alloc-method=dynamic  --ifaces=1-4:ext-1 --sc-subnet=subnet0  --sc-dns-zone=cdp.demo.local    --description=cdp_pool

-open PowerShell prompt from Start Menu
Add-DnsServerZoneDelegation -Name "demo.local" -ChildZoneName "mp" -NameServer "ssip-isilon.demo.local" -IPAddress 192.168.1.100
###


###Hadoop root setup
mkdir /ifs/cdp7
mkdir /ifs/cdp7/hadoop-root
chmod 755 /ifs/cdp7
chmod 755 /ifs/cdp7/hadoop-root
cd /ifs/cdp7/hadoop-root
touch system.txt
touch <smartconnectname>.txt

isi hdfs settings modify --zone=System --root-directory=/ifs/cdp7/hadoop-root


###Linux
create users and dirs: https://github.com/Isilon/isilon_hadoop_tools

yum install install python3-pip
yum install python3-virtualenv

cd /root
mkdir virtualenv
cd virtualenv/

virtualenv-v3 isilon_hadoop_tools
cd isilon_hadoop_tools/
source bin/activate
pip install isilon_hadoop_tools

isilon_create_users --zone=System  --onefs-user=root --onefs-password=Password123! --dist=cdp --start-uid=5000 --start-gid=5000   X.X.X.X --no-verify

isilon_create_directories  --zone=System --no-verify --onefs-user=root --onefs-password=Password123! --dist=cdp  X.X.X.X


chmod 777 xxxxxxxxxxx-System-cdp.sh
./xxxxxxxxxxx-zone-cdh6-cdh.sh
cat /etc/passwd

#copy script to any other hosts and run

###Onefs
isi auth roles create --name=hdfs_access --description="Bypass FS permissions" --zone=System
isi auth roles modify hdfs_access --add-priv=ISI_PRIV_IFS_RESTORE --zone=System
isi auth roles modify hdfs_access --add-priv=ISI_PRIV_IFS_BACKUP --zone=System


isi auth roles modify hdfs_access --add-user=hdfs --zone=System
isi auth roles view hdfs_access --zone=System
isi_for_array "isi auth mapping flush --all"
isi_for_array "isi auth cache flush --all"


###Linux
yum -y update
yum -y groupinstall "Development tools"

systemctl disable firewalld
systemctl stop firewalld

vi /etc/sysconfig/network
	HOSTNAME=<FDQN>
vi /etc/hosts
	X.X.X.X   FQDN shortname

vi /etc/selinux/config

#set to disable

yum -y install ntp

systemctl start ntpd
systemctl enable ntpd


#Cloudera Host inspector fixes
echo never > /sys/kernel/mm/transparent_hugepage/defrag
echo never > /sys/kernel/mm/transparent_hugepage/enabled


vi /etc/rc.local

if test -f /sys/kernel/mm/transparent_hugepage/enabled; then
   echo never > /sys/kernel/mm/transparent_hugepage/enabled
fi
if test -f /sys/kernel/mm/transparent_hugepage/defrag; then
   echo never > /sys/kernel/mm/transparent_hugepage/defrag
fi


vi /etc/sysctl.conf 
#(Add at the end) G, o - esc:wq
	
vm.swappiness=10

yum -y install krb5-workstation krb5-libs openldap-clients


reboot

cat /proc/sys/vm/swappiness

###install CM and CDP

###wget https://archive.cloudera.com/cm7/7.1.4/cloudera-manager-installer.bin
wget https://archive.cloudera.com/cm7/7.4.4/cloudera-manager-installer.bin
chmod u+x cloudera-manager-installer.bin
./cloudera-manager-installer.bin

systemctl status cloudera-scm-server
systemctl status cloudera-scm-server-db
systemctl status cloudera-scm-agent


http://X.X.X.X:7180
admin | admin


Create OU
Create AD cdp account
Assign AD role on OU

Kerberize CDP7

DEMO.LOCAL
launchpad.demo.local
launchpad.demo.local
demo.local
ou=CDP7,DC=demo,DC=local

-let cdp manage krb5.conf

-user added to AD and delegated

-Modify OneFS Access Zone to use Kerberos only
-Join AD and Zone to AD 
-Check SPN's on isilon


If using PowerScale CSD, 

copy powerscale csd jar to:
/opt/cloudera/cm/csd

Deploy & Install!






